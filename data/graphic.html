<!DOCTYPE html>
<html>

<head>
    <title>ESP8266 Humidity Logger</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/png" sizes="144x144" href="/favicon-144x144.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00878f">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'>
        <script src="moment.min.js"></script>

    <script  src="Chart.min.js"></script>

</head>

<body>
 
    <center>
   
       
             <div width='70%' height='50%'>
                <canvas id="canvasGraphic" padding="50">No canvas in your browser...sorry...</canvas>
             </div>
             <div id='buttons'>
             	<button onclick=btnClickedPlus()>+</button>
             	<button onclick=btnClickedMinus()>-</button>
             	<button onclick=btnClickedZoomIn()>>></button>
             	<button onclick=btnClickedZoomOut()><<</button>
             </div>
       			<script>
       						var timeFormat = 'MM/DD/YYYY HH:mm';
       								var color = Chart.helpers.color;
       				//var ctx = document.getElementById('canvasGraphic').getContext('2d');

	var config = {
			type: 'line',
			data: {
				labels: [ // Date Objects
					
				],
				datasets: [{
					label: 'Relay',
					backgroundColor: color("blue").alpha(0.5).rgbString(),
					borderColor: color("green").alpha(1).rgbString(),
					fill: false,
					data: [
					],
				},{
					label: 'Temp',
					backgroundColor: color("red").alpha(0.5).rgbString(),
					borderColor: color("cyan").alpha(1).rgbString(),
					fill: false,
					data: [
					],
				},{
					label: 'Ana in',
					backgroundColor: color("magenta").alpha(0.5).rgbString(),
					borderColor: color("black").alpha(1).rgbString(),
					fill: false,
					data: [
					],
				}]
			},
			options: {
				title: {
					text: 'Chart.js Time Scale'
				},
				scales: {
					xAxes: [{
						type: 'time',
						//distribution: 'linear',
						display: 'true',
						time: {
							parser: timeFormat,
							// unit: 'day',
							tooltipFormat: 'll HH:mm',
							//min: new Date("2019-05-20")
						},
						scaleLabel: {
							display: true,
							labelString: 'Date'
						},
						offset: true,
						scaleBeginAtZero: false

					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'value'
						}
					}]
				},
			}
		};

var myChart;

//var datos = parseCSV("time,relay,temp,analog\n11111111,0,20,7\n11111122,0,21,7.5\n11111133,0,22.5,8\n");


window.onload = function() {
			var ctx = document.getElementById('canvasGraphic').getContext('2d');
			window.myChart = new Chart(ctx, config);
			data=loadCSV();
		};


function loadCSV() {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && ( this.status == 200  || this.status == 404 ) ) {
			dataArray = parseCSV(this.responseText);
						window.myChart.update();

			return dataArray;

		}
	};
	xmlhttp.open("GET", "dataLog.csv", true);
	xmlhttp.send();
}


function parseCSV(string) {
	var array = [];
			var data1 = [];
			var data2 = [];
			var data3 = [];
			var data0 = [];

	var lines = string.split("\n");

	for (var i = 1; i < lines.length; i++) {
		var data = lines[i].split(",");
				data0.push(new Date(data[0]*1000+60*60*5*1000)); // add 5 hours for time zone, this should be automatic
				data1.push(data[1]);
				data2.push(data[2]);
				data3.push(data[3]);
		array.push(data);
	}
				config.data.datasets[0].data =(data1);
				config.data.datasets[1].data =(data2);
				config.data.datasets[2].data = (data3);
				config.data.labels=data0;
				config.options.scales.xAxes[0].time.min = data0[1];
				//console.log(data0);
					return array;

}


 
 function btnClickedPlus(){config.options.scales.xAxes[0].time.min = moment(config.options.scales.xAxes[0].time.min).add( 1,"hours");
						config.options.scales.xAxes[0].time.max = moment(config.options.scales.xAxes[0].time.max).subtract( 1,"hours");
						window.myChart.update(); }
 function btnClickedMinus(){config.options.scales.xAxes[0].time.min = moment(config.options.scales.xAxes[0].time.min).subtract( 1,"hours");
  							config.options.scales.xAxes[0].time.max = moment(config.options.scales.xAxes[0].time.max).add( 1,"hours");
							window.myChart.update(); }
 function btnClickedZoomIn(){config.options.scales.xAxes[0].time.min = moment(config.options.scales.xAxes[0].time.min).add( 1,"hours");
 							config.options.scales.xAxes[0].time.max = moment(config.options.scales.xAxes[0].time.max).add( 1,"hours");
							 window.myChart.update(); }
 function btnClickedZoomOut(){config.options.scales.xAxes[0].time.min = moment(config.options.scales.xAxes[0].time.min).subtract( 1,"hours");
 							config.options.scales.xAxes[0].time.max = moment(config.options.scales.xAxes[0].time.max).subtract( 1,"hours");
							 window.myChart.update(); }

 
</script>

    </center>



    </style>
</body>

</html>
